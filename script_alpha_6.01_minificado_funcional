const codeInput=document.getElementById("codeInput"),submitCodeBtn=document.getElementById("submitCodeBtn"),contenidoDiv=document.getElementById("contenido"),correctSound=document.getElementById("correctSound"),incorrectSound=document.getElementById("incorrectSound"),bgMusic=document.getElementById("bgMusic"),codeAudio=document.getElementById("codeAudio"),progresoParrafo=document.getElementById("progreso"),progressBarFill=document.querySelector(".progress-bar-fill"),toggleUnlockedCodesBtn=document.getElementById("toggleUnlockedCodes"),unlockedCodesPanel=document.getElementById("unlockedCodesPanel"),unlockedCodesList=document.getElementById("unlockedCodesList"),searchUnlockedCodesInput=document.getElementById("searchUnlockedCodes"),categoryFilterSelect=document.getElementById("categoryFilter"),imageModal=document.getElementById("imageModal"),modalImg=document.getElementById("modalImg"),modalCaption=document.getElementById("modalCaption"),menuButton=document.getElementById("menuButton"),dropdownMenu=document.getElementById("dropdownMenu"),achievementToastContainer=document.getElementById("achievement-toast-container"),darkModeToggle=document.getElementById("darkModeToggle"),showFavoritesBtn=document.getElementById("showFavoritesBtn"),filterFavoritesBtn=document.getElementById("filterFavoritesBtn"),audioPanel=document.getElementById("audioPanel"),audioSettingsBtn=document.getElementById("audioSettingsBtn"),closeAudioPanel=document.getElementById("closeAudioPanel"),playPauseBtn=document.getElementById("playPauseBtn"),nextTrackBtn=document.getElementById("nextTrackBtn"),prevTrackBtn=document.getElementById("prevTrackBtn"),muteBtn=document.getElementById("muteBtn"),shuffleBtn=document.getElementById("shuffleBtn"),audioVolume=document.getElementById("audioVolume"),currentTrackName=document.getElementById("currentTrackName");let failedAttempts=parseInt(localStorage.getItem("failedAttempts")||"0",10);const MAX_FAILED_ATTEMPTS=5;let desbloqueados=new Set(JSON.parse(localStorage.getItem("desbloqueados")||"[]")),logrosAlcanzados=new Set(JSON.parse(localStorage.getItem("logrosAlcanzados")||"[]")),favoritos=new Set(JSON.parse(localStorage.getItem("favoritos")||"[]")),showingFavorites=!1;const HINT_MESSAGE="Parece que no es el código correcto... sigue intentando.",playlist=["assets/audio/playlist/music1.mp3","assets/audio/playlist/music2.mp3","assets/audio/playlist/music3.mp3","assets/audio/playlist/music4.mp3","assets/audio/playlist/music5.mp3","assets/audio/playlist/music6.mp3","assets/audio/playlist/music7.mp3","assets/audio/playlist/music8.mp3","assets/audio/playlist/music9.mp3","assets/audio/playlist/music10.mp3"];let currentTrack=parseInt(localStorage.getItem("currentTrack")||"0",10);isNaN(currentTrack)||currentTrack<0||currentTrack>=playlist.length&&(currentTrack=0);let isShuffling="true"===localStorage.getItem("isShuffling"),savedVolume=parseFloat(localStorage.getItem("bgMusicVolume"));isNaN(savedVolume)&&(savedVolume=.35);let isMusicPlayingState=localStorage.getItem("isMusicPlaying")||"paused";function limpiarEntradaCodigo(e){return e?e.replace(/\u200B/g,"").replace(/\u200C/g,"").replace(/\u200D/g,"").replace(/\uFEFF/g,"").replace(/\u00A0/g," ").trim():""}function normalizarTexto(e){return e?e.toString().toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g,"").replace(/ñ/g,"n").replace(/[_\-\s]+/g,"").replace(/[^\w\d]/g,""):""}function levenshtein(e,t){e=e||"",t=t||"";const n=e.length,o=t.length;if(0===n)return o;if(0===o)return n;let r=new Array(o+1),a=new Array(o+1);for(let e=0;e<=o;e++)r[e]=e;for(let s=0;s<n;s++){a[0]=s+1;for(let n=0;n<o;n++){const o=e[s]===t[n]?0:1;a[n+1]=Math.min(a[n]+1,r[n+1]+1,r[n]+o)}const e=r;r=a,a=e}return r[o]}function isCloseMatch(e,t){const n=normalizarTexto(limpiarEntradaCodigo(e)),o=normalizarTexto(t);if(!n||!o)return!1;if(o.includes(n))return!0;const r=levenshtein(n,o),a=Math.max(o.length,n.length),s=Math.max(1,Math.floor(.18*a));if(r<=s)return!0;const i=Math.max(2,Math.ceil(.6*n.length));return o.startsWith(n.slice(0,i))}function guardarDesbloqueados(){try{localStorage.setItem("desbloqueados",JSON.stringify(Array.from(desbloqueados)))}catch(e){}}function guardarFavoritos(){try{localStorage.setItem("favoritos",JSON.stringify(Array.from(favoritos)))}catch(e){}}function guardarLogrosAlcanzados(){try{localStorage.setItem("logrosAlcanzados",JSON.stringify(Array.from(logrosAlcanzados)))}catch(e){}}
function showAchievementToast(e){if(!achievementToastContainer)return;const t=document.createElement("div");t.className="achievement-toast",t.textContent=e,achievementToastContainer.appendChild(t),t.addEventListener("animationend",(()=>t.remove()))}function actualizarProgreso(){if(!progresoParrafo||!progressBarFill)return;const e="object"==typeof mensajes&&mensajes?Object.keys(mensajes).length:0,t=desbloqueados.size,n=e>0?Math.round(t/e*100):0;if(progresoParrafo.textContent=`Has desbloqueado ${t} de ${e} códigos.`,progressBarFill.style.width=`${n}%`,progressBarFill.setAttribute("aria-valuenow",String(n)),Array.isArray(window.logros))try{window.logros.forEach((e=>{t>=e.codigo_requerido&&!logrosAlcanzados.has(e.id)&&(logrosAlcanzados.add(e.id),guardarLogrosAlcanzados(),showAchievementToast(`Logro desbloqueado: ${e.mensaje}`))}))}catch(e){}}function actualizarListaDesbloqueados(){if(!unlockedCodesList)return;unlockedCodesList.innerHTML="";const e=searchUnlockedCodesInput?normalizarTexto(limpiarEntradaCodigo(searchUnlockedCodesInput.value)):"",t=categoryFilterSelect?categoryFilterSelect.value:"",n=showingFavorites?Array.from(favoritos):Array.from(desbloqueados),o=new Set;n.sort().forEach((n=>{const r="object"==typeof mensajes&&mensajes?mensajes[n]:null;if(!r)return;const a=r.categoria||"General";o.add(a);const s=normalizarTexto(n),i=normalizarTexto(a),c=!e||s.includes(e),l=!t||normalizarTexto(t)===i;if(c&&l){const e=document.createElement("li");e.className="lista-codigo-item",e.setAttribute("tabindex","0"),e.setAttribute("role","button"),e.innerHTML=`<span class="codigo-text">${n}</span><span class="category">${a}</span>`;const t=document.createElement("button");t.className="favorite-toggle-btn";const o=favoritos.has(n);t.innerHTML=`<i class="${o?"fas":"far"} fa-heart" aria-hidden="true"></i>`,o&&t.classList.add("active"),t.setAttribute("aria-pressed",String(o)),t.setAttribute("aria-label",o?`Quitar ${n} de favoritos`:`Añadir ${n} a favoritos`),t.addEventListener("click",(e=>{e.stopPropagation(),favoritos.has(n)?favoritos.delete(n):favoritos.add(n),guardarFavoritos(),actualizarListaDesbloqueados()})),e.appendChild(t),e.addEventListener("click",(()=>mostrarContenido(n))),e.addEventListener("keypress",(e=>{"Enter"===e.key&&mostrarContenido(n)})),unlockedCodesList.appendChild(e)}})),categoryFilterSelect&&(categoryFilterSelect.innerHTML='<option value="">Todas las categorías</option>',Array.from(o).sort().forEach((e=>{const t=document.createElement("option");t.value=e,t.textContent=e,categoryFilterSelect.appendChild(t)})))}function mostrarContenido(e){if(!contenidoDiv)return;const t="object"==typeof mensajes&&mensajes?mensajes[e]:null;if(!t)return;contenidoDiv.hidden=!1,contenidoDiv.classList.remove("fade-in"),void contenidoDiv.offsetWidth,contenidoDiv.classList.add("fade-in"),contenidoDiv.innerHTML="",t.videoEmbed?(contenidoDiv.innerHTML=`\n      <h2>Video Especial</h2>\n      <p>${t.texto||""}</p>\n      <div class="video-wrapper">\n        <iframe src="${t.videoEmbed}" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen title="Video"></iframe>\n      </div>\n      <p><button id="resumeMusicBtn" class="button small-button">Reanudar Música</button></p>\n    `,bgMusic&&!bgMusic.paused&&(bgMusic.pause(),playPauseBtn&&(playPauseBtn.innerHTML='<i class="fas fa-play"></i>')),document.getElementById("resumeMusicBtn")?.addEventListener("click",(()=>{try{bgMusic.play(),playPauseBtn&&(playPauseBtn.innerHTML='<i class="fas fa-pause"></i>')}catch(e){}}))):t.imagen?(modalImg&&(modalImg.src=t.imagen,modalImg.alt=t.texto?t.texto.replace(/<[^>]+>/g,""):"Imagen"),modalCaption&&(modalCaption.textContent=t.texto?t.texto.replace(/<[^>]+>/g,""):""),imageModal&&(imageModal.style.display="flex"),bgMusic&&!bgMusic.paused&&(bgMusic.pause(),playPauseBtn&&(playPauseBtn.innerHTML='<i class="fas fa-play"></i>'))):t.audio?(contenidoDiv.innerHTML=`\n      <h2>Audio Secreto</h2>\n      <p>${t.texto||""}</p>\n      <p><button id="playCodeAudioBtn" class="button">Reproducir</button></p>\n    `,codeAudio&&(codeAudio.src=t.audio,document.getElementById("playCodeAudioBtn")?.addEventListener("click",(()=>{codeAudio.play().catch((()=>{})),document.getElementById("playCodeAudioBtn").disabled=!0})))):t.link?(contenidoDiv.innerHTML=`\n      <h2>Enlace Especial</h2>\n      <p>${t.texto||""}</p>\n      <p><a href="${t.link}" target="_blank" rel="noopener noreferrer" class="button">Ir al enlace</a></p>\n    `):t.descarga?(contenidoDiv.innerHTML=`\n      <h2>Archivo Especial</h2>\n      <p>${t.texto||""}</p>\n      <p><a href="${t.descarga.url}" download="${t.descarga.nombre}" class="button">Descargar ${t.descarga.nombre}</a></p>\n    `):t.texto?contenidoDiv.innerHTML=`<h2>Mensaje</h2>${t.texto}`:contenidoDiv.innerHTML="<p>Este código existe pero no tiene contenido asociado.</p>"}function cerrarModal(){imageModal&&(imageModal.style.display="none");try{bgMusic&&"playing"===localStorage.getItem("isMusicPlaying")&&(bgMusic.play().catch((()=>{})),playPauseBtn&&(playPauseBtn.innerHTML='<i class="fas fa-pause"></i>'))}catch(e){}}
imageModal&&imageModal.addEventListener("click",(e=>{e.target===imageModal&&cerrarModal()})),document.addEventListener("keydown",(e=>{"Escape"===e.key&&imageModal&&"flex"===imageModal.style.display&&cerrarModal()}));function fadeInAudio(e,t=.05,n=500){if(!e)return;try{e.volume=0,e.play().catch((()=>{}))}catch(e){}const o=Math.max(1,Math.round(n/(1e3*t))),r=1/o,a=setInterval((()=>{e.volume<1-r?e.volume=Math.min(1,e.volume+r):(e.volume=1,clearInterval(a))}),Math.max(10,Math.round(1e3*t)))}function fadeOutAudio(e,t=.05,n=500){if(!e)return;const o=Math.max(1,Math.round(n/(1e3*t))),r=1/o,a=setInterval((()=>{e.volume>r?e.volume=Math.max(0,e.volume-r):(e.volume=0,clearInterval(a),e.pause())}),Math.max(10,Math.round(1e3*t)))}function procesarCodigo(){if(!codeInput)return;const e=limpiarEntradaCodigo(codeInput.value||""),t=normalizarTexto(e);if(!t)return codeInput.classList.remove("success"),codeInput.classList.add("error"),contenidoDiv.innerHTML="<h2>Código Incorrecto</h2><p>Introduce un código válido.</p>",void(contenidoDiv.hidden=!1);contenidoDiv&&contenidoDiv.hidden=!0,codeInput.classList.remove("success","error");if("object"!=typeof mensajes||!mensajes)return contenidoDiv.hidden=!1,void(contenidoDiv.innerHTML="<h2>Error</h2><p>Los datos no están cargados (data.js). Intenta recargar la página.</p>");let n=null;for(const e of Object.keys(mensajes))if(normalizarTexto(e)===t){n=e;break}if(!n){let r={key:null,score:1/0};for(const e of Object.keys(mensajes)){const a=normalizarTexto(e),s=levenshtein(t,a);s<r.score&&(r={key:e,score:s,targetNorm:a})}const a=r.key,o=a&&isCloseMatch(e,a);if(o&&a)return contenidoDiv.hidden=!1,contenidoDiv.innerHTML=`\n        <h2>Vas por buen camino</h2>\n        <p>Parece que estás cerca del código correcto. Revisa si falta alguna parte o letra.</p>\n        <p class="hint-small">Sugerencia: prueba completarlo (por ejemplo: "${a}").</p>\n      `,codeInput.classList.add("error"),void(codeInput.value=e)}if(n)return correctSound&&correctSound.play().catch((()=>{})),codeInput.classList.add("success"),mostrarContenido(n),desbloqueados.has(n)||(desbloqueados.add(n),guardarDesbloqueados(),actualizarProgreso(),showAchievementToast(`Código desbloqueado: ${n}`)),actualizarListaDesbloqueados(),failedAttempts=0,localStorage.setItem("failedAttempts","0"),void(codeInput.value="");incorrectSound&&incorrectSound.play().catch((()=>{})),codeInput.classList.add("error"),failedAttempts++,localStorage.setItem("failedAttempts",String(failedAttempts)),failedAttempts>=MAX_FAILED_ATTEMPTS?(function(){const e=Object.keys(mensajes).filter((e=>!desbloqueados.has(e)&&mensajes[e].pista));let t=HINT_MESSAGE;if(e.length>0){const n=e[Math.floor(Math.random()*e.length)];t=mensajes[n].pista||t,localStorage.setItem("ultimoCodigoPista",n)}contenidoDiv.hidden=!1,contenidoDiv.innerHTML=`<h2>Pista</h2><p>${t}</p>`,failedAttempts=0,localStorage.setItem("failedAttempts","0")}()):(contenidoDiv.hidden=!1,contenidoDiv.innerHTML=`<h2>Código Incorrecto</h2><p>Intentos fallidos: ${failedAttempts} de ${MAX_FAILED_ATTEMPTS}</p><p>Sigue intentando.</p>`),codeInput.value=""}
submitCodeBtn&&submitCodeBtn.addEventListener("click",procesarCodigo),codeInput&&(codeInput.addEventListener("keydown",(e=>{"Enter"===e.key&&(e.preventDefault(),procesarCodigo())})),codeInput.addEventListener("focus",(()=>{codeInput.value=limpiarEntradaCodigo(codeInput.value)})));function friendlyTrackName(e){try{const t=e.split("/").pop();return t.replace(/\.[^/.]+$/,"").replace(/[_-]/g," ")}catch(t){return e}}function loadTrack(e,t=!0){bgMusic&&(currentTrack=(e+playlist.length)%playlist.length,localStorage.setItem("currentTrack",String(currentTrack)),bgMusic.src=playlist[currentTrack],bgMusic.load(),currentTrackName&&(currentTrackName.textContent=friendlyTrackName(playlist[currentTrack])),bgMusic.volume=parseFloat(audioVolume?.value||savedVolume),t?bgMusic.play().then((()=>{playPauseBtn&&(playPauseBtn.innerHTML='<i class="fas fa-pause"></i>'),localStorage.setItem("isMusicPlaying","playing")})).catch((()=>{playPauseBtn&&(playPauseBtn.innerHTML='<i class="fas fa-play"></i>'),localStorage.setItem("isMusicPlaying","paused")})):playPauseBtn&&(playPauseBtn.innerHTML='<i class="fas fa-play"></i>'))}function playPause(){bgMusic&&(bgMusic.paused?bgMusic.play().then((()=>{playPauseBtn&&(playPauseBtn.innerHTML='<i class="fas fa-pause"></i>'),localStorage.setItem("isMusicPlaying","playing")})).catch((()=>{})):(bgMusic.pause(),playPauseBtn&&(playPauseBtn.innerHTML='<i class="fas fa-play"></i>'),localStorage.setItem("isMusicPlaying","paused")))}function nextTrack(){currentTrack=isShuffling?Math.floor(Math.random()*playlist.length):(currentTrack+1)%playlist.length,loadTrack(currentTrack,!0)}function prevTrack(){currentTrack=isShuffling?Math.floor(Math.random()*playlist.length):(currentTrack-1+playlist.length)%playlist.length,loadTrack(currentTrack,!0)}bgMusic&&bgMusic.addEventListener("ended",nextTrack),playPauseBtn&&playPauseBtn.addEventListener("click",playPause),nextTrackBtn&&nextTrackBtn.addEventListener("click",nextTrack),prevTrackBtn&&prevTrackBtn.addEventListener("click",prevTrack),muteBtn&&muteBtn.addEventListener("click",(()=>{bgMusic&&(bgMusic.muted=!bgMusic.muted,muteBtn.innerHTML=bgMusic.muted?'<i class="fas fa-volume-mute"></i>':'<i class="fas fa-volume-up"></i>',localStorage.setItem("bgMusicMuted",bgMusic.muted?"true":"false"))})),shuffleBtn&&shuffleBtn.addEventListener("click",(()=>{isShuffling=!isShuffling,localStorage.setItem("isShuffling",isShuffling?"true":"false"),shuffleBtn.style.color=isShuffling?"var(--highlight-pink)":""})),audioVolume&&(audioVolume.value=String(savedVolume),audioVolume.addEventListener("input",(()=>{savedVolume=parseFloat(audioVolume.value),bgMusic&&(bgMusic.volume=savedVolume),localStorage.setItem("bgMusicVolume",String(savedVolume))}))),audioSettingsBtn&&audioSettingsBtn.addEventListener("click",(()=>{audioPanel&&(audioPanel.classList.add("show"),audioPanel.setAttribute("aria-hidden","false"),setTimeout((()=>{playPauseBtn?.focus()}),150),cerrarMenu())})),closeAudioPanel&&closeAudioPanel.addEventListener("click",(()=>{audioPanel&&(audioPanel.classList.remove("show"),audioPanel.setAttribute("aria-hidden","true"),audioSettingsBtn?.focus())}));let interactionStarted=!1;function startOnInteraction(){if(interactionStarted)return;interactionStarted=!0;const e="playing"===localStorage.getItem("isMusicPlaying");bgMusic&&(bgMusic.volume=savedVolume,bgMusic.muted="true"===localStorage.getItem("bgMusicMuted"),e?loadTrack(currentTrack,!0):loadTrack(currentTrack,!1)),document.removeEventListener("click",startOnInteraction),document.removeEventListener("keydown",startOnInteraction)}document.addEventListener("click",startOnInteraction,{once:!0,passive:!0}),document.addEventListener("keydown",startOnInteraction,{once:!0,passive:!0});const exportBtn=document.getElementById("exportProgressBtn"),importBtn=document.getElementById("importProgressBtn"),importInput=document.getElementById("importProgressInput"),resetBtn=document.getElementById("resetProgressBtn");function exportarProgreso(){const e={desbloqueados:Array.from(desbloqueados),favoritos:Array.from(favoritos),logrosAlcanzados:Array.from(logrosAlcanzados),fecha:(new Date).toISOString()},t=new Blob([JSON.stringify(e,null,2)],{type:"application/json"}),n=URL.createObjectURL(t),o=document.createElement("a");o.href=n,o.download=`progreso_${(new Date).toISOString().slice(0,10)}.json`,o.click(),URL.revokeObjectURL(n),showAchievementToast("Progreso exportado")}function importarProgreso(e){if(!e)return;const t=new FileReader;t.onload=o=>{try{const e=JSON.parse(o.target.result);desbloqueados=new Set(e.desbloqueados||[]),favoritos=new Set(e.favoritos||[]),logrosAlcanzados=new Set(e.logrosAlcanzados||[]),guardarDesbloqueados(),guardarFavoritos(),guardarLogrosAlcanzados(),actualizarProgreso(),actualizarListaDesbloqueados(),showAchievementToast("Progreso importado")}catch(e){alert("Archivo inválido o con formato incorrecto.")}},t.readAsText(e)}function resetearProgreso(){if(!confirm("Restablecer progreso\n\nAntes de continuar, considera exportar una copia de seguridad si crees que podrías querer recuperar tus avances más tarde.\n\nAl restablecer se eliminará lo siguiente:\n- Códigos descubiertos\n- Favoritos\n- Logros\n- Configuración de tema\n- Preferencias de audio (pista, volumen, mute, shuffle)\n- Registro de intentos\n\nEsta acción no se puede deshacer. ¿Deseas continuar?"))return;try{localStorage.removeItem("desbloqueados"),localStorage.removeItem("favoritos"),localStorage.removeItem("logrosAlcanzados"),localStorage.removeItem("failedAttempts"),localStorage.removeItem("ultimoCodigoPista"),localStorage.removeItem("isMusicPlaying"),localStorage.removeItem("currentTrack"),localStorage.removeItem("bgMusicVolume"),localStorage.removeItem("bgMusicMuted"),localStorage.removeItem("theme"),localStorage.removeItem("isShuffling")}catch(e){}desbloqueados=new Set,favoritos=new Set,logrosAlcanzados=new Set,failedAttempts=0,document.body.classList.remove("dark-mode"),darkModeToggle&&(darkModeToggle.innerHTML='<i class="fas fa-moon"></i> Modo Oscuro'),bgMusic&&(bgMusic.pause(),bgMusic.src=""),contenidoDiv&&(contenidoDiv.hidden=!0),actualizarProgreso(),actualizarListaDesbloqueados(),showAchievementToast("Progreso restablecido"),cerrarMenu()}exportBtn&&exportBtn.addEventListener("click",(()=>{exportarProgreso(),cerrarMenu()})),importBtn&&importInput&&(importBtn.addEventListener("click",(()=>{importInput.click(),cerrarMenu()})),importInput.addEventListener("change",(e=>{e.target.files&&e.target.files[0]&&importarProgreso(e.target.files[0]),importInput.value=""}))),resetBtn&&resetBtn.addEventListener("click",resetearProgreso),toggleUnlockedCodesBtn&&toggleUnlockedCodesBtn.addEventListener("click",toggleUnlockedCodes);function toggleUnlockedCodes(){if(!unlockedCodesPanel||!toggleUnlockedCodesBtn)return;const e=unlockedCodesPanel.hidden;unlockedCodesPanel.hidden=!e,toggleUnlockedCodesBtn.setAttribute("aria-expanded",String(!e)),toggleUnlockedCodesBtn.textContent=e?"Ocultar Códigos Desbloqueados":"Mostrar Códigos Desbloqueados",showingFavorites=!1,filterFavoritesBtn&&(filterFavoritesBtn.classList.remove("active"),filterFavoritesBtn.setAttribute("aria-pressed","false")),actualizarListaDesbloqueados()}showFavoritesBtn&&showFavoritesBtn.addEventListener("click",(()=>{unlockedCodesPanel&&unlockedCodesPanel.hidden&&toggleUnlockedCodes(),showingFavorites=!0,filterFavoritesBtn&&(filterFavoritesBtn.classList.add("active"),filterFavoritesBtn.setAttribute("aria-pressed","true")),searchUnlockedCodesInput&&(searchUnlockedCodesInput.value=""),categoryFilterSelect&&(categoryFilterSelect.value=""),actualizarListaDesbloqueados(),cerrarMenu()})),filterFavoritesBtn&&filterFavoritesBtn.addEventListener("click",(()=>{showingFavorites=!showingFavorites,filterFavoritesBtn.classList.toggle("active",showingFavorites),filterFavoritesBtn.setAttribute("aria-pressed",String(showingFavorites)),actualizarListaDesbloqueados()})),searchUnlockedCodesInput&&searchUnlockedCodesInput.addEventListener("input",actualizarListaDesbloqueados),categoryFilterSelect&&categoryFilterSelect.addEventListener("change",actualizarListaDesbloqueados),menuButton&&menuButton.addEventListener("click",(()=>{const e="true"===menuButton.getAttribute("aria-expanded");menuButton.setAttribute("aria-expanded",String(!e)),dropdownMenu&&(dropdownMenu.classList.toggle("show"),dropdownMenu.setAttribute("aria-hidden",String(e)),e||dropdownMenu.querySelector("a, button")?.focus())})),document.addEventListener("click",(e=>{menuButton&&dropdownMenu&&!menuButton.contains(e.target)&&!dropdownMenu.contains(e.target)&&dropdownMenu.classList.contains("show")&&cerrarMenu()})),dropdownMenu&&dropdownMenu.addEventListener("keydown",(e=>{const t=dropdownMenu.querySelectorAll("a, button");if(!t.length)return;const n=t[0],o=t[t.length-1];"Escape"===e.key?(cerrarMenu(),menuButton.focus(),e.preventDefault()):"Tab"===e.key&&(e.shiftKey&&document.activeElement===n?(o.focus(),e.preventDefault()):!e.shiftKey&&document.activeElement===o&&(n.focus(),e.preventDefault()))}));function cerrarMenu(){dropdownMenu&&(dropdownMenu.classList.remove("show"),dropdownMenu.setAttribute("aria-hidden","true")),menuButton&&menuButton.setAttribute("aria-expanded","false")}!function(){try{"dark-mode"===localStorage.getItem("theme")?(document.body.classList.add("dark-mode"),darkModeToggle&&(darkModeToggle.innerHTML='<i class="fas fa-sun"></i> Modo Claro')):darkModeToggle&&(darkModeToggle.innerHTML='<i class="fas fa-moon"></i> Modo Oscuro'),darkModeToggle&&darkModeToggle.addEventListener("click",(()=>{document.body.classList.toggle("dark-mode");const e=document.body.classList.contains("dark-mode");localStorage.setItem("theme",e?"dark-mode":"light-mode"),darkModeToggle.innerHTML=e?'<i class="fas fa-sun"></i> Modo Claro':'<i class="fas fa-moon"></i> Modo Oscuro'}))}catch(e){}}(),document.addEventListener("DOMContentLoaded",(()=>{"object"!=typeof mensajes||!mensajes?(progresoParrafo&&(progresoParrafo.textContent="Los datos no están disponibles. data.js no cargado."),contenidoDiv&&(contenidoDiv.hidden=!1,contenidoDiv.innerHTML="<h2>Atención</h2><p>Parece que los contenidos (data.js) no están cargados. Revisa la consola o recarga la página.</p>")):(audioVolume&&(audioVolume.value=String(savedVolume)),shuffleBtn&&(shuffleBtn.style.color=isShuffling?"var(--highlight-pink)":""),muteBtn&&((e=localStorage.getItem("bgMusicMuted"))&&(bgMusic.muted="true"===e),muteBtn.innerHTML=bgMusic.muted?'<i class="fas fa-volume-mute"></i>':'<i class="fas fa-volume-up"></i>'),playPauseBtn&&(playPauseBtn.innerHTML="playing"===localStorage.getItem("isMusicPlaying")?'<i class="fas fa-pause"></i>':'<i class="fas fa-play"></i>'),bgMusic&&(bgMusic.src=playlist[currentTrack],currentTrackName&&(currentTrackName.textContent=friendlyTrackName(playlist[currentTrack])),bgMusic.volume=savedVolume),actualizarProgreso(),actualizarListaDesbloqueados());var e})),window.procesarCodigo=procesarCodigo,window.mostrarContenido=mostrarContenido,window.cerrarModal=cerrarModal,window.loadTrack=loadTrack,window.playPause=playPause;
